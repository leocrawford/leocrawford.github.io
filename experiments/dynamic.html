<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Dynamic venn.js example</title>
    <style>
        body {
            font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
            font-size: 14px;
        }
    </style>
</head>

<body>
    <div style="float:left;padding:20px">
        <table>
            <tr>
                <td>|A|</td>
                <td>
                    <input class="input-mini venn_area" id="A" type="number" value="16">
                </td>
            </tr>
            <tr>
                <td>|B|</td>
                <td>
                    <input class="input-mini venn_area" id="B" type="number" value="16">
                </td>
            </tr>
            <tr>
                <td>|C|</td>
                <td>
                    <input class="input-mini venn_area" id="C" type="number" value="12">
                </td>
            </tr>
            <tr>
                <td>|A&#8745B|</td>
                <td>
                    <input class="input-mini venn_area" id="A,B" type="number" value="4">
                </td>
            </tr>
            <tr>
                <td>|A&#8745C|</td>
                <td>
                    <input class="input-mini venn_area" id="A,C" type="number" value="4">
                </td>
            </tr>
            <tr>
                <td>|B&#8745C|</td>
                <td>
                    <input class="input-mini venn_area" id="B,C" type="number" value="3">
                </td>
            </tr>
            <tr>
                <td>|A&#8745B&#8745C|&nbsp</td>
                <td>
                    <input class="input-mini venn_area" id="A,B,C" type="number" value="2">
                </td>
            </tr>
        </table>
    </div>
    <div id="venn"></div>
    <div style="clear: both;"></div>

</body>
<script src="../js/d3.v4.min.js"></script>
<!-- <script src="https://d3js.org/d3-hierarchy.v1.min.js"></script> -->
<script src="venn.js"></script>
<script>
    function getSetIntersections() {
        areas = d3.selectAll(".venn_area").nodes().map(
            function(element) {
                var size = parseFloat(element.value);
                return {
                    sets: element.id.split(","),
                    size: size,
                    children: fillArrayWithLetters(size, element.id.replace(/\,/g, ""))
                };

            });
        return areas;
    }

    function fillArrayWithLetters(n, prefix) {
        var arr = Array.apply(null, Array(n));
        return arr.map(function(x, i) {
            return {
                name: prefix + i,
            }
        });
    }


    // draw the initial set
    var chart = venn.VennDiagram()
        .width(600)
        .height(500);

        function ticked() {
              svg.selectAll(".point")
                .attr("cx", function(d) {
                      return d.x;
                })
                .attr("cy", function(d) {
                    return d.y;
                });
        }

    var simulation  = d3.forceSimulation()
            //      .force("charge", d3.forceManyBody().strength(50))
            .force("collide", d3.forceCollide(8))
            .force("x", d3.forceX(function x(node) {
                    return node.px;
            }))
            .force("y", d3.forceY(function y(node) {
                return node.py;
            }))
            .force("constrain",constrain())
            .on("tick", ticked)
          ;


      function constrain() {
        var nodes;
       function force(alpha) {
      // console.log("constrain");}
console.log(nodes.length);
      for (var i = 0, n = nodes.length, node, k = alpha * 0.1; i < n; ++i) {
        node = nodes[i];
        console.log(node);
        node.vx = 0;
        node.x = 0;
      }}

      force.initialize = function(_) {
        nodes = _;
    }
    return force;
  }


    d3.select("#venn").datum(getSetIntersections()).call(chart);
    var svg = d3.select("svg");
    update();
    // redraw the sets on any change in input
    d3.selectAll("input").on("change", function() {
        d3.select("#venn").datum(getSetIntersections()).call(chart).call(update);
    });



    // tweak style
    var colours = ['black', 'red', 'blue'];
    d3.selectAll("#venn .venn-circle path")
        .style("fill-opacity", 0)
        .style("stroke-width", 10)
        .style("stroke-opacity", .5)
        .style("stroke", function(d, i) {
            return colours[i];
        });


    d3.selectAll("#venn .venn-circle").selectAll("text")
        .style("fill", function(d, i) {
            return colours[i]
        })
        .style("font-size", "32px")
        .style("font-weight", "100");


    function dragstarted(d) {
        if (!d3.event.active) {
            simulation.alphaTarget(0.3).restart();
        }
        d.fx = d.x;
        d.fy = d.y;
    }

    function dragged(d) {
        // console.log(d);
        d.fx = d3.event.x;
        d.fy = d3.event.y;
    }

    function dragended(d) {
        if (!d3.event.active) simulation.alphaTarget(0);
        d.fx = null;
        d.fy = null;
    }


    function update() {
        simulation
            .nodes(addPoints())
            .alpha(1)
    }

    function addPoints() {
        var nodes = [];

        var datapoints = d3.selectAll("#venn .venn-circle").selectAll(".point")
            .data(function(d, i) {
                var x = (d == null || d.children == null) ? [] : d.children;
                pushArray(nodes, x);
                return x;
            }, function(d) {
                return d.name;
            });

        console.log("enter and exit");
        console.log(datapoints._enter[0]);
        console.log(datapoints._exit[0]);

        // lets copy the current x and y value back from object to data so that
        // the simulation carries on rather than restarting
        datapoints.each(function(d, i) {
            d.x = this.cx.animVal.value;
            d.y = this.cy.animVal.value;
        });

        var node = datapoints.enter()
            .append("circle")
            .attr("class", "point")
            .attr("r", 8)
            .each(function(d) {
                var bb = this.parentElement.firstChild.getBBox();
                d.px = bb.x + bb.width / 2;
            })
            .each(function(d) {
                var bb = this.parentElement.firstChild.getBBox();
                d.py = bb.y + bb.height / 2;
            })
            .call(d3.drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended));

        datapoints.each(function(d) {
                var bb = bbox(this);
                d.px = bb.x + bb.width / 2;
            })
            .each(function(d) {
                var bb = bbox(this);
                d.py = bb.y + bb.height / 2;
            })

        datapoints.exit().remove();
        return nodes;
    }

    function bbox(t) {
        return t.parentNode.childNodes[0].getBBox();
    }

    function pushArray(arr, arr2) {
        arr.push.apply(arr, arr2);
    }
</script>

</html>
